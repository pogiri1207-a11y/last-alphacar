pipeline {
    agent any

    environment {
        HARBOR_URL = '192.168.0.169'
        HARBOR_PROJECT = 'giri'
        // ì„œë¹„ìŠ¤ ëª©ë¡ ì •ì˜
        SERVICES = 'aichat community main mypage news quote search'
        
        // [ì¶”ê°€] GitOpsë¥¼ ìœ„í•œ ì„¤ì •
        MANIFEST_REPO_URL = 'https://github.com/pogiri1207-a11y/alphacar-deploy.git' // ì‹¤ì œ ì£¼ì†Œ í™•ì¸ í•„ìš”
        GIT_CREDENTIAL_ID = 'github-cred' // ì‚¬ì§„ì—ì„œ í™•ì¸ëœ ID
    }

    stages {
        // ... (ê¸°ì¡´ stage 1, 2, 3, 4ëŠ” ë™ì¼í•˜ê²Œ ìœ ì§€) ...
        stage('1. Prepare & SonarQube') { /* ìƒëµ */ }
        stage('2. Trivy Source Scan') { /* ìƒëµ */ }
        stage('3. Docker Build') { /* ìƒëµ */ }
        stage('4. Push to Harbor') { /* ìƒëµ */ }

        // [í•µì‹¬ ì¶”ê°€] 5ë‹¨ê³„: Argo CDê°€ ë°”ë¼ë³´ëŠ” Git ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
        stage('5. Update Manifests (GitOps)') {
            steps {
                script {
                    // 1. ì„ì‹œ ë””ë ‰í† ë¦¬ì— Manifest ì €ì¥ì†Œ í´ë¡ 
                    dir('manifest-update') {
                        checkout([$class: 'GitSCM', 
                            branches: [[name: 'main']], 
                            userRemoteConfigs: [[url: "${env.MANIFEST_REPO_URL}", credentialsId: "${env.GIT_CREDENTIAL_ID}"]]
                        ])

                        def serviceList = env.SERVICES.split(' ')
                        for (service in serviceList) {
                            // ê° ì„œë¹„ìŠ¤ë³„ YAML íŒŒì¼ ê²½ë¡œ ì§€ì • (Argo CD ì‚¬ì§„ì˜ Path ì°¸ê³ : k8s/backend/)
                            def yamlPath = "k8s/backend/${service}-backend.yaml"
                            
                            echo "ğŸ“ [${service}]ì˜ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ${env.GIT_SHA}ë¡œ ì—…ë°ì´íŠ¸ ì¤‘..."
                            
                            // 2. sed ëª…ë ¹ì–´ë¡œ ì´ë¯¸ì§€ íƒœê·¸(Git SHA) êµì²´
                            // í˜•ì‹: 192.168.0.169/giri/alphacar-service:TAG
                            sh """
                                sed -i 's|image: ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:.*|image: ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA}|' ${yamlPath}
                            """
                        }

                        // 3. ë³€ê²½ì‚¬í•­ Git Push
                        sh """
                            git config user.email "jenkins@alphacar.com"
                            git config user.name "Jenkins-CI"
                            git add .
                            git commit -m "Update images to ${env.GIT_SHA} [skip ci]" || echo "No changes to commit"
                            git push origin main
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            echo "âœ… ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
            // ë¹Œë“œ í›„ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë¦¬
            cleanWs()
        }
        failure {
            echo "âŒ ë¹Œë“œ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
        }
    }
}
