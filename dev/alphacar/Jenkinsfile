pipeline {
    agent any

    environment {
        // [ÎèÑÍµ¨] Jenkins ToolsÏóê Îì±Î°ùÌïú Ïù¥Î¶ÑÍ≥º ÏùºÏπòÌï¥Ïïº Ìï®
        DOCKER_TOOL = 'docker'
        SONAR_TOOL = 'sonar-scanner'
        
        // [ÏÑúÎ≤Ñ] URL Î∞è Ï†ïÎ≥¥ ÏÑ§Ï†ï
        SONARQUBE_ID = 'sonarqube'
        SONAR_URL = 'http://sonarqube-service.jenkins.svc.cluster.local:9000'
        HARBOR_URL = '192.168.0.169' 
        HARBOR_PROJECT = 'giri'
        
        // [Ïù¥ÎØ∏ÏßÄ] Í≥†Ï†ï Ïù¥ÎØ∏ÏßÄ Ïù¥Î¶Ñ
        FRONTEND_IMAGE = 'alphacar-frontend'
        NGINX_IMAGE = 'alphacar-nginx'

        // [GitOps] Î∞∞Ìè¨ Î†àÌè¨ÏßÄÌÜ†Î¶¨ Ï†ïÎ≥¥
        DEPLOY_REPO = 'https://github.com/pogiri1207-a11y/last-alphacar.git'
        CREDENTIAL_ID_GITHUB = 'github-cred'
    }

    stages {
        stage('Initialize Tools') {
            steps {
                script {
                    // ÎèÑÍµ¨ Ïù¥Î¶ÑÎßåÏúºÎ°ú Í≤ΩÎ°úÎ•º Ï∞æÏïÑ ÌôòÍ≤ΩÎ≥ÄÏàòÏóê Ï†ÄÏû• (ÏóêÎü¨ Î∞©ÏßÄ)
                    def dHome = tool "${DOCKER_TOOL}"
                    env.DOCKER_BIN = "${dHome}/bin/docker"
                    
                    def sHome = tool "${SONAR_TOOL}"
                    env.SONAR_SCANNER_BIN = "${sHome}/bin/sonar-scanner"
                    
                    echo "‚úÖ Docker Binary: ${env.DOCKER_BIN}"
                    echo "‚úÖ Sonar Scanner Binary: ${env.SONAR_SCANNER_BIN}"
                }
            }
        }

        stage('Checkout Code') {
            steps {
                checkout scm
                script {
                    // ÌòÑÏû¨ Ïª§Î∞ãÏùò 7ÏûêÎ¶¨ SHA Ï∂îÏ∂ú
                    env.GIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    echo "üìå Current Git SHA: ${env.GIT_SHA}"
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    dir('dev/alphacar') {
                        withSonarQubeEnv("${SONARQUBE_ID}") {
                            sh "${env.SONAR_SCANNER_BIN} -Dsonar.projectKey=alphacar-backend -Dsonar.sources=backend -Dsonar.host.url=${SONAR_URL}"
                        }
                    }
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    dir('dev/alphacar') {
                        def backendServices = ['aichat', 'community', 'drive', 'mypage', 'quote', 'search', 'main']
                        backendServices.each { service ->
                            sh "${env.DOCKER_BIN} build --build-arg APP_NAME=${service} -f backend/Dockerfile -t ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA} backend/"
                        }
                        sh "${env.DOCKER_BIN} build -f frontend/Dockerfile -t ${HARBOR_URL}/${HARBOR_PROJECT}/${FRONTEND_IMAGE}:${env.GIT_SHA} frontend/"
                        sh "${env.DOCKER_BIN} build -f nginx.Dockerfile -t ${HARBOR_URL}/${HARBOR_PROJECT}/${NGINX_IMAGE}:${env.GIT_SHA} ."
                    }
                }
            }
        }

        stage('Trivy Security Scan') {
            steps {
                script {
                    echo "üõ°Ô∏è Starting Security Scan with Trivy (Scanning main service as representative)..."
                    // TrivyÎ•º 1ÌöåÏö© Ïª®ÌÖåÏù¥ÎÑàÎ°ú Ïã§ÌñâÌïòÏó¨ Ï∑®ÏïΩÏ†ê Í≤ÄÏÇ¨
                    sh "${env.DOCKER_BIN} run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image --severity HIGH,CRITICAL ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-main:${env.GIT_SHA}"
                }
            }
        }

        stage('Push to Harbor') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'harbor-cred', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    script {
                        sh "echo \$PASS | ${env.DOCKER_BIN} login ${HARBOR_URL} -u \$USER --password-stdin"
                        
                        def backendServices = ['aichat', 'community', 'drive', 'mypage', 'quote', 'search', 'main']
                        backendServices.each { service ->
                             sh "${env.DOCKER_BIN} push ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA}"
                        }
                        sh "${env.DOCKER_BIN} push ${HARBOR_URL}/${HARBOR_PROJECT}/${FRONTEND_IMAGE}:${env.GIT_SHA}"
                        sh "${env.DOCKER_BIN} push ${HARBOR_URL}/${HARBOR_PROJECT}/${NGINX_IMAGE}:${env.GIT_SHA}"
                        
                        sh "${env.DOCKER_BIN} logout ${HARBOR_URL}"
                    }
                }
            }
        }

        stage('Update Manifests (GitOps)') {
            steps {
                script {
                    // Î≥ÑÎèÑÏùò Ìè¥ÎçîÏóê Î∞∞Ìè¨Ïö© Î†àÌè¨ÏßÄÌÜ†Î¶¨ ÌÅ¥Î°†
                    dir('deploy-repo') {
                        git credentialsId: "${CREDENTIAL_ID_GITHUB}", url: "${DEPLOY_REPO}"

                        // YAML ÌååÏùº ÎÇ¥Ïùò Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏Î•º ÏÉàÎ°ú ÎπåÎìúÎêú SHA ÌÉúÍ∑∏Î°ú ÍµêÏ≤¥
                        def backendServices = ['aichat', 'community', 'drive', 'mypage', 'quote', 'search', 'main']
                        backendServices.each { service ->
                            sh "sed -i 's|image: .*/alphacar-${service}:.*|image: ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA}|g' k8s/backend/${service}-backend.yaml"
                        }

                        sh "sed -i 's|image: .*/${FRONTEND_IMAGE}:.*|image: ${HARBOR_URL}/${HARBOR_PROJECT}/${FRONTEND_IMAGE}:${env.GIT_SHA}|g' k8s/frontend/frontend-deployment.yaml"

                        // Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ ÍπÉÌóàÎ∏åÏóê Ïª§Î∞ã Î∞è Ìë∏Ïãú
                        sh """
                            git config user.email "jenkins@jenkins.com"
                            git config user.name "jenkins"
                            git add .
                            git commit -m "chore: update image tag to SHA-${env.GIT_SHA} [skip ci]" || echo "No changes to commit"
                            git push origin main
                        """
                    }
                }
            }
        }
    }
}
