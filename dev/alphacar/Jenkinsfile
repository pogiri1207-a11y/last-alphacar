pipeline {
    agent any

    environment {
        SONAR_TOOL = 'sonar-scanner'
        SONARQUBE_ID = 'sonarqube'
        SONAR_URL = 'http://sonarqube-service.jenkins.svc.cluster.local:9000'
        HARBOR_URL = '192.168.0.169'
        HARBOR_PROJECT = 'giri'
        FRONTEND_IMAGE = 'alphacar-frontend'
        NGINX_IMAGE = 'alphacar-nginx'
        DEPLOY_REPO = 'https://github.com/pogiri1207-a11y/last-alphacar.git'
        CREDENTIAL_ID_GITHUB = 'github-cred'
    }

    stages {
        stage('Setup Tools & Checkout') {
            steps {
                script {
                    // ì  í‚¨ìŠ¤ ì‹œìŠ¤í…œ ì„¤ì •ì— ë“±ë¡ëœ ë„êµ¬ ê²½ë¡œ í™•ë³´
                    def sonarPath = tool name: 'sonar-scanner', type: 'hudson.plugins.sonar.SonarRunnerInstallation'
                    def dockerPath = tool name: 'docker', type: 'org.jenkinsci.plugins.docker.commons.tools.DockerTool'
                    env.PATH = "${sonarPath}/bin:${dockerPath}/bin:${env.PATH}"
                }
                checkout scm
                script {
                    env.GIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                dir('dev/alphacar') {
                    withSonarQubeEnv("${SONARQUBE_ID}") {
                        sh "sonar-scanner -Dsonar.projectKey=alphacar-backend -Dsonar.sources=backend -Dsonar.host.url=${SONAR_URL}"
                    }
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                dir('dev/alphacar') {
                    script {
                        // ì‚¬ìš©ìž ls ê²°ê³¼ ë°˜ì˜: news í¬í•¨, drive ì œì™¸
                        def backendServices = ['aichat', 'community', 'main', 'mypage', 'news', 'quote', 'search']

                        backendServices.each { service ->
                            echo "ðŸ”¨ ì„œë¹„ìŠ¤ ë¹Œë“œ ì¤‘: ${service}"
                            // [í•µì‹¬ ìˆ˜ì •] -f ê²½ë¡œë¥¼ ê° ì„œë¹„ìŠ¤ í´ë” ë‚´ë¶€ì˜ Dockerfileë¡œ ì§€ì •
                            // ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸(ë§ˆì§€ë§‰ ê²½ë¡œ)ëŠ” ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì°¸ì¡°ë¥¼ ìœ„í•´ backend/ í´ë” ìœ ì§€
                            sh "docker build -f backend/${service}/Dockerfile -t ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA} backend/"
                        }

                        // í”„ë¡ íŠ¸ì—”ë“œ ë° Nginx (ë£¨íŠ¸ ë˜ëŠ” ì§€ì •ëœ ê²½ë¡œ ìœ ì§€)
                        sh "docker build -f frontend/Dockerfile -t ${HARBOR_URL}/${HARBOR_PROJECT}/${FRONTEND_IMAGE}:${env.GIT_SHA} frontend/"
                        sh "docker build -f nginx.Dockerfile -t ${HARBOR_URL}/${HARBOR_PROJECT}/${NGINX_IMAGE}:${env.GIT_SHA} ."
                    }
                }
            }
        }

        stage('Push to Harbor') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'harbor-cred', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    script {
                        sh "echo \$PASS | docker login ${HARBOR_URL} -u \$USER --password-stdin"
                        dir('dev/alphacar') {
                            def backendServices = ['aichat', 'community', 'main', 'mypage', 'news', 'quote', 'search']
                            backendServices.each { service ->
                                sh "docker push ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA}"
                            }
                            sh "docker push ${HARBOR_URL}/${HARBOR_PROJECT}/${FRONTEND_IMAGE}:${env.GIT_SHA}"
                            sh "docker push ${HARBOR_URL}/${HARBOR_PROJECT}/${NGINX_IMAGE}:${env.GIT_SHA}"
                        }
                        sh "docker logout ${HARBOR_URL}"
                    }
                }
            }
        }
    }
}
