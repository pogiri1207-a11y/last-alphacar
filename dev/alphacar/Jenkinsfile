pipeline {
    agent any

    environment {
        HARBOR_URL = '192.168.0.169'
        HARBOR_PROJECT = 'giri'
        SERVICES = 'aichat community main mypage news quote search'

        // [ìµœì¢… í™•ì¸] Argo CDìš© ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì €ì¥ì†Œ ì£¼ì†Œ
        MANIFEST_REPO_URL = 'https://github.com/pogiri1207-a11y/last-alphacar.git'
        
        GIT_CREDENTIAL_ID = 'github-cred'
        DOCKER_CREDENTIAL_ID = 'harbor-cred'
    }

    stages {
        stage('1. Prepare & SonarQube') {
            steps {
                cleanWs()
                checkout scm
                script {
                    // ì´ë¯¸ì§€ íƒœê·¸ë¡œ ì‚¬ìš©í•  Git Short Hash ì¶”ì¶œ
                    env.GIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    
                    def sonarPath = tool name: 'sonar-scanner', type: 'hudson.plugins.sonar.SonarRunnerInstallation'
                    env.PATH = "${sonarPath}/bin:${env.PATH}"
                }
                dir('dev/alphacar') {
                    withSonarQubeEnv('sonarqube') {
                        sh "sonar-scanner -Dsonar.projectKey=alphacar-backend -Dsonar.sources=backend -Dsonar.host.url=http://sonarqube-service.jenkins.svc.cluster.local:9000"
                    }
                }
            }
        }

        stage('2. ì•ˆì „í•œ ë³‘ë ¬ ë¹Œë“œ & í‘¸ì‹œ (2ê°œì”©)') {
            steps {
                script {
                    def serviceList = env.SERVICES.split(' ')
                    // ì„œë²„ ìì› ë³´í˜¸ë¥¼ ìœ„í•´ 2ê°œì”© ìˆœì°¨ì  ë³‘ë ¬ ì‹¤í–‰
                    for (int i = 0; i < serviceList.size(); i += 2) {
                        def batch = serviceList[i..(Math.min(i + 1, serviceList.size() - 1))]
                        def actions = [:]

                        batch.each { service ->
                            actions["Build-${service}"] = {
                                stage("Process ${service}") {
                                    echo "ğŸ”¨ [${service}] ì‘ì—… ì‹œì‘..."
                                    dir('dev/alphacar') {
                                        // ë„ì»¤ ë¹Œë“œ (ì•ˆì •ì„±ì„ ìœ„í•´ í•„ìš”ì‹œ --no-cache ì¶”ê°€ ê°€ëŠ¥)
                                        sh "docker build -f backend/${service}/Dockerfile -t ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA} backend/"

                                        // í•˜ë²„ ë¡œê·¸ì¸ ë° í‘¸ì‹œ
                                        withCredentials([usernamePassword(credentialsId: "${env.DOCKER_CREDENTIAL_ID}", usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                                            sh "echo \$PASS | docker login ${HARBOR_URL} -u \$USER --password-stdin"
                                            sh "docker push ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA}"
                                        }
                                    }
                                }
                            }
                        }
                        parallel actions
                        sh "sleep 3"
                    }
                }
            }
        }

        stage('3. Update Manifests (GitOps)') {
            steps {
                script {
                    echo "ğŸš€ [GitOps] Manifest ì €ì¥ì†Œ ì—…ë°ì´íŠ¸ ì‹œì‘"
                    dir('manifest-update') {
                        // [ìˆ˜ì •] LocalBranch: 'main'ì„ ì„¤ì •í•˜ì—¬ Detached HEAD ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
                        checkout([$class: 'GitSCM', 
                            branches: [[name: 'main']], 
                            extensions: [[$class: 'LocalBranch', localBranch: 'main']], 
                            userRemoteConfigs: [[url: "${env.MANIFEST_REPO_URL}", credentialsId: "${env.GIT_CREDENTIAL_ID}"]]
                        ])

                        def serviceList = env.SERVICES.split(' ')
                        for (service in serviceList) {
                            def yamlPath = "k8s/backend/${service}-backend.yaml"
                            
                            // íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì—¬ ì—ëŸ¬ ë°©ì§€
                            sh """
                                if [ -f "${yamlPath}" ]; then
                                    echo "ğŸ“ [${service}] ì—…ë°ì´íŠ¸ ì¤‘..."
                                    sed -i 's|image: ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:.*|image: ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA}|' ${yamlPath}
                                else
                                    echo "âš ï¸ [${service}] íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ê±´ë„ˆëœë‹ˆë‹¤: ${yamlPath}"
                                fi
                            """
                        }

                        // [ìˆ˜ì •] ë³€ê²½ ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ Push ì§„í–‰
                        sh """
                            git config user.email "jenkins@alphacar.com"
                            git config user.name "Jenkins-CI"
                            git add .
                            if [ -n "\$(git status --porcelain)" ]; then
                                git commit -m "Update images to ${env.GIT_SHA} [skip ci]"
                                git push origin main
                            else
                                echo "âœ… ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë¯€ë¡œ í‘¸ì‹œë¥¼ ìƒëµí•©ë‹ˆë‹¤."
                            fi
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            // ëª¨ë“  ì‘ì—… ì™„ë£Œ í›„ ë„ì»¤ ì´ë¯¸ì§€ ì •ë¦¬
            sh "docker image prune -f"
            cleanWs()
        }
    }
}
