pipeline {
    agent any
    environment {
        HARBOR_URL = '192.168.0.169'
        HARBOR_PROJECT = 'giri'
    }
    stages {
        stage('Initialize & SonarQube') {
            steps {
                cleanWs()
                checkout scm
                script {
                    // Git Hash ì¶”ì¶œ ë° ì†Œë‚˜ ìŠ¤ìºë„ˆ ì„¤ì •
                    env.GIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    def sonarPath = tool name: 'sonar-scanner', type: 'hudson.plugins.sonar.SonarRunnerInstallation'
                    env.PATH = "${sonarPath}/bin:${env.PATH}"
                }
                dir('dev/alphacar') {
                    withSonarQubeEnv('sonarqube') { 
                        sh "sonar-scanner -Dsonar.projectKey=alphacar-backend -Dsonar.sources=backend -Dsonar.host.url=http://sonarqube-service.jenkins.svc.cluster.local:9000"
                    }
                }
            }
        }

        stage('Parallel Docker Build (2-Way)') {
            steps {
                script {
                    def backendServices = ['aichat', 'community', 'main', 'mypage', 'news', 'quote', 'search']
                    // ë©”ëª¨ë¦¬ ë³´í˜¸ë¥¼ ìœ„í•´ 2ê°œì”© ë¬¶ì–´ì„œ ì²˜ë¦¬
                    def chunks = backendServices.collate(2) 
                    
                    chunks.each { chunk ->
                        def builds = [:]
                        chunk.each { service ->
                            builds["Build ${service}"] = {
                                dir('dev/alphacar') {
                                    echo "ðŸ”¨ ë¹Œë“œ ì¤‘: ${service}"
                                    sh "docker build -f backend/${service}/Dockerfile -t ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA} backend/"
                                }
                            }
                        }
                        // ë¬¶ì¸ 2ê°œ ì„œë¹„ìŠ¤ë§Œ ë³‘ë ¬ ì‹¤í–‰
                        parallel builds
                    }
                }
            }
        }

        stage('Parallel Trivy Scan (2-Way)') {
            steps {
                script {
                    def backendServices = ['aichat', 'community', 'main', 'mypage', 'news', 'quote', 'search']
                    // ìŠ¤ìº” ì‹œì—ë„ ë©”ëª¨ë¦¬ ì ìœ ìœ¨ì„ ê³ ë ¤í•´ 2ê°œì”© ì²˜ë¦¬
                    def chunks = backendServices.collate(2) 
                    
                    chunks.each { chunk ->
                        def scans = [:]
                        chunk.each { service ->
                            scans["Scan ${service}"] = {
                                def imageName = "${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA}"
                                echo "ðŸ›¡ï¸ ë³´ì•ˆ ìŠ¤ìº” ì¤‘: ${service}"
                                // Docker ê¸°ë°˜ Trivy ì‹¤í–‰ (Not found ì—ëŸ¬ ë°©ì§€)
                                sh "docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --severity HIGH,CRITICAL --no-progress ${imageName}"
                            }
                        }
                        parallel scans
                    }
                }
            }
        }

        stage('Push to Harbor') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'harbor-cred', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    sh "echo \$PASS | docker login ${HARBOR_URL} -u \$USER --password-stdin"
                    script {
                        def backendServices = ['aichat', 'community', 'main', 'mypage', 'news', 'quote', 'search']
                        backendServices.each { name ->
                            echo "ðŸš€ Harbor í‘¸ì‹œ ì¤‘: ${name}"
                            sh "docker push ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${name}:${env.GIT_SHA}"
                        }
                    }
                    sh "docker logout ${HARBOR_URL}"
                }
            }
        }
    }
}
