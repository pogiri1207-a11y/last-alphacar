pipeline {
    agent any
    
    environment {
        HARBOR_URL = '192.168.0.169'
        HARBOR_PROJECT = 'giri'
        // ì„œë¹„ìŠ¤ ëª©ë¡ ì •ì˜
        SERVICES = 'aichat community main mypage news quote search'
    }

    stages {
        stage('1. Prepare & SonarQube') {
            steps {
                cleanWs()
                checkout scm
                script {
                    // Git Hash ì¶”ì¶œ
                    env.GIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    
                    // Sonar Scanner ì‹¤í–‰
                    def sonarPath = tool name: 'sonar-scanner', type: 'hudson.plugins.sonar.SonarRunnerInstallation'
                    env.PATH = "${sonarPath}/bin:${env.PATH}"
                }
                dir('dev/alphacar') {
                    withSonarQubeEnv('sonarqube') { 
                        sh """
                        sonar-scanner \
                        -Dsonar.projectKey=alphacar-backend \
                        -Dsonar.sources=backend \
                        -Dsonar.host.url=http://sonarqube-service.jenkins.svc.cluster.local:9000
                        """
                    }
                }
            }
        }

        stage('2. Trivy Source Scan (Sequential)') {
            steps {
                script {
                    def serviceList = env.SERVICES.split(' ')
                    for (service in serviceList) {
                        echo "ğŸ›¡ï¸ [${service}] ì†ŒìŠ¤ ë³´ì•ˆ ìŠ¤ìº” ì¤‘..."
                        dir("dev/alphacar/backend/${service}") {
                            sh """
                            mkdir -p /tmp/trivy-cache
                            docker run --rm \
                                -v /tmp/trivy-cache:/root/.cache/trivy \
                                -v \$(pwd):/src \
                                aquasec/trivy fs --severity HIGH,CRITICAL --no-progress --scanners vuln /src
                            """
                        }
                    }
                }
            }
        }

        stage('3. Docker Build (Sequential)') {
            steps {
                script {
                    def serviceList = env.SERVICES.split(' ')
                    for (service in serviceList) {
                        echo "ğŸ”¨ [${service}] ë¹Œë“œ ì‹œì‘..."
                        dir('dev/alphacar') {
                            // Docker contextë¥¼ backend/ í´ë”ë¡œ ì§€ì •í•˜ì—¬ root node_modules ì°¸ì¡° ê°€ëŠ¥ì¼€ í•¨
                            sh "docker build -f backend/${service}/Dockerfile -t ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA} backend/"
                            
                            // ë¹Œë“œ ì§í›„ ì•ˆ ì“°ëŠ” ë ˆì´ì–´ ì‚­ì œ (ìš©ëŸ‰ í™•ë³´)
                            sh "docker image prune -f"
                        }
                    }
                }
            }
        }

        stage('4. Push to Harbor') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'harbor-cred', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                        sh "echo \$PASS | docker login ${HARBOR_URL} -u \$USER --password-stdin"
                        
                        def serviceList = env.SERVICES.split(' ')
                        for (service in serviceList) {
                            echo "ğŸš€ [${service}] í‘¸ì‹œ ì¤‘..."
                            sh "docker push ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA}"
                        }
                        
                        sh "docker logout ${HARBOR_URL}"
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "âœ… ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
        }
        failure {
            echo "âŒ ë¹Œë“œ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
        }
    }
}
