pipeline {
    agent any

    environment {
        // 1. Harbor 설정 (사진의 harbor-cred 사용)
        DOCKER_REGISTRY = '192.168.0.169'
        IMAGE_NAME      = 'alphacar-project/alphacar-main' 
        TAG             = "${BUILD_NUMBER}"
        
        // 2. Argo CD가 바라보는 Git 저장소 (사진 속 Repo 주소 참고)
        GIT_REPO_URL    = 'https://github.com/pogiri1207-a11y/alphacar-deploy.git'
        
        // 3. 사진 속 ID로 매칭 완료!
        GIT_CREDENTIAL_ID   = 'github-cred'  // 수정됨
        DOCKER_CREDENTIAL_ID = 'harbor-cred' // 수정됨
    }

    stages {
        stage('Source Checkout') {
            steps {
                // 저장소에서 소스 가져오기
                git branch: 'main', credentialsId: "${GIT_CREDENTIAL_ID}", url: "${GIT_REPO_URL}"
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    // Harbor에 로그인하여 이미지 업로드
                    docker.withRegistry("http://${DOCKER_REGISTRY}", "${DOCKER_CREDENTIAL_ID}") {
                        def appImage = docker.build("${DOCKER_REGISTRY}/${IMAGE_NAME}:${TAG}")
                        appImage.push()
                        appImage.push("latest")
                    }
                }
            }
        }

        stage('Manifest Update (GitOps)') {
            steps {
                script {
                    sh """
                        git config user.email "jenkins@alphacar.com"
                        git config user.name "Jenkins-CI"
                        
                        # 사진의 Argo CD 'Path'가 k8s/backend 이므로 해당 경로 수정
                        # 대상 파일이 main-backend.yaml 인지 꼭 확인하세요!
                        sed -i 's|image: ${DOCKER_REGISTRY}/${IMAGE_NAME}:.*|image: ${DOCKER_REGISTRY}/${IMAGE_NAME}:${TAG}|' k8s/backend/main-backend.yaml
                        
                        git add k8s/backend/main-backend.yaml
                        git commit -m "Update image to ${TAG} [skip ci]"
                        git push origin main
                    """
                }
            }
        }
    }
}
