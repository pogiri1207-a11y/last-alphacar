pipeline {
    agent any

    environment {
        HARBOR_URL = '192.168.0.169' //
        HARBOR_PROJECT = 'giri' //
        SERVICES = 'aichat community main mypage news quote search' //

        // [ìµœì¢… í™•ì¸ëœ ì£¼ì†Œ]
        MANIFEST_REPO_URL = 'https://github.com/pogiri1207-a11y/last-alphacar.git'
        
        GIT_CREDENTIAL_ID = 'github-cred'
    }

    stages {
        stage('Test Setup') {
            steps {
                script {
                    // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ê°€ìƒì˜ íƒœê·¸(GIT_SHA)ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
                    env.GIT_SHA = "test-tag-123" 
                }
            }
        }

        stage('3. Update Manifests (GitOps) - ONLY TEST') {
            steps {
                script {
                    dir('manifest-update') {
                        // ì €ì¥ì†Œ í´ë¡  í…ŒìŠ¤íŠ¸
                        checkout([$class: 'GitSCM', 
                            branches: [[name: 'main']], 
                            userRemoteConfigs: [[url: "${env.MANIFEST_REPO_URL}", credentialsId: "${env.GIT_CREDENTIAL_ID}"]]
                        ])

                        def serviceList = env.SERVICES.split(' ')
                        for (service in serviceList) {
                            // ê²½ë¡œ í™•ì¸: k8s/backend/
                            def yamlPath = "k8s/backend/${service}-backend.yaml"
                            echo "ğŸ“ [${service}] ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸ ì¤‘..."
                            sh "sed -i 's|image: ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:.*|image: ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA}|' ${yamlPath}"
                        }

                        // Push í…ŒìŠ¤íŠ¸
                        sh """
                            git config user.email "jenkins@alphacar.com"
                            git config user.name "Jenkins-CI-Test"
                            git add .
                            git commit -m "Test: GitOps logic check [skip ci]" || echo "No changes"
                            git push origin main
                        """
                    }
                }
            }
        }
    }
}
