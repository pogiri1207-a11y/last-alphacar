pipeline {
    agent any
    environment {
        SONAR_TOOL = 'sonar-scanner'
        DOCKER_TOOL = 'docker' // 젠킨스 도구 관리에서 설정한 이름
        
        SONARQUBE_ID = 'sonarqube'
        SONAR_URL = 'http://sonarqube-service.jenkins.svc.cluster.local:9000'
        HARBOR_URL = '192.168.0.169'
        HARBOR_PROJECT = 'giri'
        FRONTEND_IMAGE = 'alphacar-frontend'
        NGINX_IMAGE = 'alphacar-nginx'
        DEPLOY_REPO = 'https://github.com/pogiri1207-a11y/last-alphacar.git'
        CREDENTIAL_ID_GITHUB = 'github-cred'
    }
    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
                script { env.GIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim() }
            }
        }
        stage('SonarQube Analysis') {
            steps {
                script {
                    def sHome = tool "${SONAR_TOOL}"
                    dir('dev/alphacar') {
                        withSonarQubeEnv("${SONARQUBE_ID}") {
                            sh "${sHome}/bin/sonar-scanner -Dsonar.projectKey=alphacar-backend -Dsonar.sources=backend -Dsonar.host.url=${SONAR_URL}"
                        }
                    }
                }
            }
        }
        stage('Build Docker Images') {
            steps {
                script {
                    // [핵심] 젠킨스 도구 설치 경로를 가져옵니다.
                    def dHome = tool name: "${DOCKER_TOOL}", type: 'docker'
                    def dBin = "${dHome}/bin/docker" // 도커 실행 파일의 실제 위치
                    
                    dir('dev/alphacar') {
                        def backendServices = ['aichat', 'community', 'drive', 'mypage', 'quote', 'search', 'main']
                        backendServices.each { service ->
                            // 'docker' 대신 '${dBin}' 전체 경로를 사용합니다.
                            sh "${dBin} build --build-arg APP_NAME=${service} -f backend/Dockerfile -t ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA} backend/"
                        }
                        sh "${dBin} build -f frontend/Dockerfile -t ${HARBOR_URL}/${HARBOR_PROJECT}/${FRONTEND_IMAGE}:${env.GIT_SHA} frontend/"
                        sh "${dBin} build -f nginx.Dockerfile -t ${HARBOR_URL}/${HARBOR_PROJECT}/${NGINX_IMAGE}:${env.GIT_SHA} ."
                    }
                }
            }
        }
        stage('Push to Harbor') {
            steps {
                script {
                    def dHome = tool name: "${DOCKER_TOOL}", type: 'docker'
                    def dBin = "${dHome}/bin/docker"
                    
                    withCredentials([usernamePassword(credentialsId: 'harbor-cred', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                        sh "echo \$PASS | ${dBin} login ${HARBOR_URL} -u \$USER --password-stdin"
                        dir('dev/alphacar') {
                            def backendServices = ['aichat', 'community', 'drive', 'mypage', 'quote', 'search', 'main']
                            backendServices.each { service ->
                                 sh "${dBin} push ${HARBOR_URL}/${HARBOR_PROJECT}/alphacar-${service}:${env.GIT_SHA}"
                            }
                            sh "${dBin} push ${HARBOR_URL}/${HARBOR_PROJECT}/${FRONTEND_IMAGE}:${env.GIT_SHA}"
                            sh "${dBin} push ${HARBOR_URL}/${HARBOR_PROJECT}/${NGINX_IMAGE}:${env.GIT_SHA}"
                        }
                        sh "${dBin} logout ${HARBOR_URL}"
                    }
                }
            }
        }
    }
}
