# 1. ê³µí†µ ë² ì´ìŠ¤
FROM node:20-alpine AS base
WORKDIR /app

# ğŸ”¹ ë¹Œë“œ ì‹œê°„ì„ ì¤„ì´ê¸° ìœ„í•´ í…”ë ˆë©”íŠ¸ë¦¬ ë¹„í™œì„±í™” ë° í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
ENV NEXT_TELEMETRY_DISABLED=1
RUN apk add --no-cache libc6-compat && \
    npm install -g npm@latest

# 2. ì˜ì¡´ì„± ì„¤ì¹˜ ìŠ¤í…Œì´ì§€
FROM base AS deps
WORKDIR /app

# ìºì‹œ íš¨ìœ¨ì„ ìœ„í•´ íŒ¨í‚¤ì§€ íŒŒì¼ë§Œ ë¨¼ì € ë³µì‚¬ (9ë¶„ ë‹¨ì¶•ì˜ í•µì‹¬)
COPY package.json package-lock.json ./
# ğŸ”¹ --prefer-offlineì„ ì‚¬ìš©í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ì§€ì—° ìµœì†Œí™”
RUN npm ci --prefer-offline --no-audit --progress=false --legacy-peer-deps

# 3. ë¹Œë“œ ìŠ¤í…Œì´ì§€
FROM base AS builder
WORKDIR /app

# ì´ì „ ìŠ¤í…Œì´ì§€ì˜ node_modules ì¬ì‚¬ìš©
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# ğŸ”¹ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ì—ëŸ¬ ë°©ì§€ ë° ë©”ëª¨ë¦¬ ì œí•œ)
ENV PATH /app/node_modules/.bin:$PATH
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_OPTIONS="--max-old-space-size=2048"

# ğŸ”¹ ë¹Œë“œ ì‹¤í–‰
RUN npm run build

# 4. ì‹¤í–‰ ìŠ¤í…Œì´ì§€ (ìµœì¢… ì´ë¯¸ì§€ - ë§¤ìš° ê°€ë²¼ì›€)
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# ë³´ì•ˆ ìœ ì € ìƒì„±
RUN addgroup --system --gid 1001 nodejs \
    && adduser --system --uid 1001 nextjs

# ğŸ”¹ Standalone ê²°ê³¼ë¬¼ë§Œ ë³µì‚¬ (Push ì‹œê°„ì„ ìˆ˜ ë¶„ì—ì„œ ìˆ˜ ì´ˆë¡œ ë‹¨ì¶•)
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs
EXPOSE 3000
ENV PORT=3000

# ì‹¤í–‰
CMD ["node", "server.js"]
