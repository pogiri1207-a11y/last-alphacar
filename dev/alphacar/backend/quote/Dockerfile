# --- 1ë‹¨ê³„: ë¹Œë“œ ìŠ¤í…Œì´ì§€ (Builder) ---
FROM node:20-alpine AS builder

# ë¹Œë“œ ì‹œ í•„ìš”í•œ í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
RUN apk add --no-cache libc6-compat
WORKDIR /app

# [ìµœì í™” 1] íŒ¨í‚¤ì§€ ì„¤ì • íŒŒì¼ë§Œ ë¨¼ì € ë³µì‚¬ (ìºì‹œ í™œìš© ê·¹ëŒ€í™”)
# ë£¨íŠ¸ì™€ quote í´ë”ì˜ ì„¤ì • íŒŒì¼ì„ ë¨¼ì € ë³µì‚¬í•˜ì—¬ ì˜ì¡´ì„± ì„¤ì¹˜ ë‹¨ê³„ë¥¼ ìºì‹±í•©ë‹ˆë‹¤.
COPY package*.json ./
COPY quote/package*.json ./quote/

# [ìµœì í™” 2] @nestjs/cli ì „ì—­ ì„¤ì¹˜ ì œê±° ë° npm ci ì‚¬ìš©
# ì „ì—­ ì„¤ì¹˜(-g)ëŠ” ë§¤ë²ˆ 1ë¶„ ì´ìƒ ì†Œìš”ë©ë‹ˆë‹¤. npxë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œê°„ì„ ë‹¨ì¶•í•©ë‹ˆë‹¤.
RUN npm ci --legacy-peer-deps

# [ìµœì í™” 3] ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ (ì˜ì¡´ì„± ì„¤ì¹˜ ì´í›„ ìˆ˜í–‰)
COPY . .

# [ìµœì í™” 4] ë¹Œë“œ ì‹¤í–‰ (ë©”ëª¨ë¦¬ ì œí•œ í•˜í–¥ ë° npx ì‚¬ìš©)
# ê°€ìš© ë©”ëª¨ë¦¬ 5GB í™˜ê²½ì—ì„œ ë³‘ë ¬ ë¹Œë“œë¥¼ ìœ„í•´ 2048MBë¡œ ì œí•œí•©ë‹ˆë‹¤.
RUN cd quote && \
    echo "ğŸš€ Starting nest build for quote..." && \
    NODE_OPTIONS="--max-old-space-size=2048" npx nest build

# --- 2ë‹¨ê³„: ì‹¤í–‰ ìŠ¤í…Œì´ì§€ (Runner) ---
FROM node:20-alpine
WORKDIR /app

RUN apk add --no-cache libc6-compat

# [ìµœì í™” 5] ì‹¤í–‰ì— í•„ìš”í•œ ìµœì†Œ íŒŒì¼ë§Œ ë³µì‚¬
# ì´ë¯¸ì§€ ìš©ëŸ‰ì„ ì¤„ì—¬ì„œ Harborë¡œ ì „ì†¡(Push)í•˜ëŠ” ì‹œê°„ì„ ë‹¨ì¶•í•©ë‹ˆë‹¤.
COPY --from=builder /app/quote/dist ./dist
COPY --from=builder /app/quote/node_modules ./node_modules
COPY --from=builder /app/quote/package.json ./package.json

EXPOSE 3000

# NestJS ë¹Œë“œ ê²°ê³¼ë¬¼ ì‹¤í–‰
CMD ["node", "dist/main"]
