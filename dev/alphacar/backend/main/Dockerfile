# --- 1ë‹¨ê³„: ë¹Œë“œ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine AS builder

RUN apk add --no-cache libc6-compat
WORKDIR /app

# 1. ì˜ì¡´ì„± ì„¤ì¹˜ ìµœì í™”
# ë£¨íŠ¸ package.jsonê³¼ main ì„œë¹„ìŠ¤ì˜ package.jsonì„ ë™ì‹œì— ë³µì‚¬í•©ë‹ˆë‹¤.
COPY package*.json ./
COPY main/package*.json ./main/

# [í•µì‹¬ ìˆ˜ì •] 
# - ê¸€ë¡œë²Œ @nestjs/cli ì„¤ì¹˜ë¥¼ ì œê±°í•˜ì—¬ 1~2ë¶„ì„ ë‹¨ì¶•í•©ë‹ˆë‹¤. (npx ì‚¬ìš©)
# - npm install ëŒ€ì‹  npm cië¥¼ ì‚¬ìš©í•˜ë©´ ë¹Œë“œ í™˜ê²½ì—ì„œ ë” ë¹ ë¥´ê³  ì •í™•í•©ë‹ˆë‹¤.
RUN npm ci --legacy-peer-deps

# 2. ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY main/ ./main/
COPY libs/ ./libs/ 
# (ë§Œì•½ ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ libs í´ë” ë“±ì— ìˆë‹¤ë©´ í•¨ê»˜ ë³µì‚¬í•´ì•¼ ë¹Œë“œê°€ ë©ë‹ˆë‹¤.)

# 3. ë¹Œë“œ ì‹¤í–‰
# ê°€ìš© ë©”ëª¨ë¦¬ê°€ 5GBì´ë¯€ë¡œ, ë³‘ë ¬ ë¹Œë“œë¥¼ ìœ„í•´ ë©”ëª¨ë¦¬ ì œí•œì„ 2048ë¡œ ë‚®ì¶¥ë‹ˆë‹¤.
RUN cd main && \
    echo "ğŸš€ Starting nest build for main..." && \
    NODE_OPTIONS="--max-old-space-size=2048" npx nest build

# --- 2ë‹¨ê³„: ì‹¤í–‰ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine
WORKDIR /app

RUN apk add --no-cache libc6-compat

# 4. ê²°ê³¼ë¬¼ ë³µì‚¬
# ë¹Œë“œëœ distì™€ ì‹¤í–‰ì— í•„ìš”í•œ node_modulesë§Œ ê°€ì ¸ì™€ ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ì¤„ì…ë‹ˆë‹¤.
COPY --from=builder /app/main/dist ./dist
COPY --from=builder /app/main/node_modules ./node_modules
COPY --from=builder /app/main/package.json ./package.json

EXPOSE 3000

# 5. ì‹¤í–‰
CMD ["node", "dist/main"]
