# 1ë‹¨ê³„: ë¹Œë“œ ìŠ¤í…Œì´ì§€
FROM node:20-alpine AS builder
RUN apk add --no-cache libc6-compat
WORKDIR /app

# 1. íŒ¨í‚¤ì§€ íŒŒì¼ ë³µì‚¬ (ë£¨íŠ¸ ë° ì„œë¹„ìŠ¤)
COPY package*.json ./
COPY main/package*.json ./main/

# 2. ì˜ì¡´ì„± ì„¤ì¹˜ ë° Nest CLI ì „ì—­ ì„¤ì¹˜
RUN npm ci --legacy-peer-deps && npm install -g @nestjs/cli

# 3. ì†ŒìŠ¤ ì „ì²´ ë³µì‚¬ (tsconfig.json, nest-cli.json, libs í´ë” ë“±ì´ ëª¨ë‘ í¬í•¨ë¨)
COPY . .

# 4. ğŸ”¹ í•´ë‹¹ í´ë”ë¡œ ì´ë™í•˜ì—¬ ë¹Œë“œ (tsconfig ì—ëŸ¬ í•´ê²°)
RUN cd main && nest build

# 2ë‹¨ê³„: ì‹¤í–‰ ìŠ¤í…Œì´ì§€
FROM node:20-alpine
WORKDIR /app
RUN apk add --no-cache libc6-compat

# 5. ê²°ê³¼ë¬¼ ë³µì‚¬ (ì ˆëŒ€ ê²½ë¡œ ì£¼ì˜)
COPY --from=builder /app/main/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/main/package.json ./package.json

EXPOSE 3000
CMD ["node", "dist/main"]
