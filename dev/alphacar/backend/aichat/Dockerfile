# --- 1ë‹¨ê³„: ë¹Œë“œ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine AS builder

RUN apk add --no-cache libc6-compat
WORKDIR /app

# 1. ë£¨íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
COPY package*.json ./
RUN npm install -g @nestjs/cli && \
    npm install --legacy-peer-deps

# 2. community ì˜ì¡´ì„± ì„¤ì¹˜ (ì¤‘ìš”!)
# community í´ë”ì˜ package.jsonì„ ë³µì‚¬í•´ì„œ ì„¤ì¹˜í•©ë‹ˆë‹¤.
COPY community/package.json ./community/
RUN cd community && npm install --legacy-peer-deps

# 3. ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# 4. ë¹Œë“œ ì‹¤í–‰
# --verbose ì˜µì…˜ ì œê±° ë° community í´ë”ì—ì„œ ë¹Œë“œ
RUN cd community && \
    echo "ğŸš€ Starting nest build for community..." && \
    NODE_OPTIONS="--max-old-space-size=4096" nest build

# --- 2ë‹¨ê³„: ì‹¤í–‰ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine
WORKDIR /app

RUN apk add --no-cache libc6-compat

# 5. ê²°ê³¼ë¬¼ ë³µì‚¬
# communityì˜ ê²°ê³¼ë¬¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
COPY --from=builder /app/community/dist ./dist
COPY --from=builder /app/community/node_modules ./node_modules
COPY --from=builder /app/community/package.json ./package.json

EXPOSE 3000

CMD ["node", "dist/main"]
