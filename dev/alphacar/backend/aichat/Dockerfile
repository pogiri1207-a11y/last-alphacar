# --- 1ë‹¨ê³„: ë¹Œë“œ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine AS builder

# ë¹Œë“œì— í•„ìš”í•œ ìµœì†Œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apk add --no-cache libc6-compat
WORKDIR /app

# 1. ì˜ì¡´ì„± ì„¤ì¹˜ (ìºì‹œ í™œìš© í•µì‹¬)
# ë£¨íŠ¸ì™€ í•´ë‹¹ ì„œë¹„ìŠ¤ì˜ ì„¤ì • íŒŒì¼ì„ ë¨¼ì € ë³µì‚¬í•˜ì—¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ì‹œê°„ì„ ë‹¨ì¶•í•©ë‹ˆë‹¤.
COPY package*.json ./
COPY community/package*.json ./community/

# @nestjs/cli ì „ì—­ ì„¤ì¹˜ ì œê±° (ì‹œê°„ ë‹¨ì¶•) -> npxë¡œ ëŒ€ì²´ ê°€ëŠ¥
# npm install ëŒ€ì‹  npm cië¥¼ ì‚¬ìš©í•˜ë©´ ë” ë¹ ë¥´ê³  ì•ˆì •ì ì…ë‹ˆë‹¤.
RUN npm ci --legacy-peer-deps

# 2. ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ (ì˜ì¡´ì„± ì„¤ì¹˜ ì´í›„ì— ìˆ˜í–‰)
COPY . .

# 3. ë¹Œë“œ ì‹¤í–‰
# ë©”ëª¨ë¦¬ ì œí•œì„ ê°€ìš©ëŸ‰ì— ë§ì¶° 2GB(2048)ë¡œ ì¡°ì • (4096ì€ í˜„ì¬ ì„œë²„ì—ì„œ ìœ„í—˜í•¨)
RUN cd community && \
    echo "ğŸš€ Starting nest build for community..." && \
    NODE_OPTIONS="--max-old-space-size=2048" npx nest build

# --- 2ë‹¨ê³„: ì‹¤í–‰ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine
WORKDIR /app

RUN apk add --no-cache libc6-compat

# 4. ê²°ê³¼ë¬¼ë§Œ ë³µì‚¬ (ì´ë¯¸ì§€ ìš©ëŸ‰ ë‹¤ì´ì–´íŠ¸)
# ì‹¤í–‰ì— ë¶ˆí•„ìš”í•œ íŒŒì¼ì€ ì œì™¸í•˜ê³  distì™€ node_modulesë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
COPY --from=builder /app/community/dist ./dist
COPY --from=builder /app/community/node_modules ./node_modules
COPY --from=builder /app/community/package.json ./package.json

EXPOSE 3000

# 5. ì‹¤í–‰ (ê²½ë¡œ í™•ì¸: ë³´í†µ dist/main.js ë˜ëŠ” dist/src/main.js)
CMD ["node", "dist/main"]
