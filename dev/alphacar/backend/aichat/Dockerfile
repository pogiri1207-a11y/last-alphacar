# --- 1ë‹¨ê³„: ë¹Œë“œ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine AS builder

RUN apk add --no-cache libc6-compat
WORKDIR /app

# 1. íŒ¨í‚¤ì§€ íŒŒì¼ ë³µì‚¬
COPY package*.json ./
COPY aichat/package*.json ./aichat/

# 2. ì˜ì¡´ì„± ì„¤ì¹˜ (ì—¬ê¸°ì„œ ì´ë¯¸ nest cliê°€ ì„¤ì¹˜ë©ë‹ˆë‹¤)
RUN npm ci --legacy-peer-deps

# 3. ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# 4. [í•µì‹¬ ìˆ˜ì •] ê¸€ë¡œë²Œ ì„¤ì¹˜ ì—†ì´ ì‹¤í–‰ (npx ì‚¬ìš©)
# PATHì— ë£¨íŠ¸ì˜ bin í´ë”ë¥¼ ì¶”ê°€í•˜ì—¬ nest ëª…ë ¹ì–´ë¥¼ ë°”ë¡œ ì¸ì‹í•˜ê²Œ í•©ë‹ˆë‹¤.
ENV PATH /app/node_modules/.bin:$PATH

RUN cd aichat && \
    echo "ğŸš€ Starting nest build for aichat..." && \
    NODE_OPTIONS="--max-old-space-size=2048" nest build
