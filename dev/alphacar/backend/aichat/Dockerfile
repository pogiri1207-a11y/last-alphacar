# --- 1ë‹¨ê³„: ë¹Œë“œ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine AS builder

RUN apk add --no-cache libc6-compat
WORKDIR /app

# 1. íŒ¨í‚¤ì§€ íŒŒì¼ ë³µì‚¬ (ë£¨íŠ¸ ê¸°ì¤€)
COPY package*.json ./
COPY aichat/package*.json ./aichat/

# 2. ì˜ì¡´ì„± ì„¤ì¹˜ (ë£¨íŠ¸ì—ì„œ í•œ ë²ˆë§Œ)
# ğŸ”¹ ì—¬ê¸°ì„œ 'nest' ë°”ì´ë„ˆë¦¬ê°€ í™•ì‹¤íˆ ìƒì„±ë©ë‹ˆë‹¤.
RUN npm ci --legacy-peer-deps

# 3. ëª¨ë“  ì†ŒìŠ¤ ë³µì‚¬
COPY . .

# 4. [í•µì‹¬ ìˆ˜ì •] cd í•˜ì§€ ì•Šê³  ë£¨íŠ¸ì—ì„œ npxë¡œ ë¹Œë“œ
# ì´ë ‡ê²Œ í•˜ë©´ ê²½ë¡œ ë¬¸ì œ(127 ì—ëŸ¬)ë¥¼ ì™„ì „íˆ í”¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
RUN npx nest build aichat

# --- 2ë‹¨ê³„: ì‹¤í–‰ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine
WORKDIR /app
RUN apk add --no-cache libc6-compat

# 5. ê²°ê³¼ë¬¼ ë³µì‚¬ (aichatì˜ dist í´ë” í™•ì¸)
COPY --from=builder /app/aichat/dist ./dist
COPY --from=builder /app/aichat/node_modules ./node_modules
COPY --from=builder /app/aichat/package.json ./package.json

EXPOSE 3000
CMD ["node", "dist/main"]
