# --- 1ë‹¨ê³„: ë¹Œë“œ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine AS builder

RUN apk add --no-cache libc6-compat
WORKDIR /app

# 1. íŒ¨í‚¤ì§€ íŒŒì¼ ë³µì‚¬ (ìºì‹œ í™œìš©)
COPY package*.json ./
COPY aichat/package*.json ./aichat/

# 2. ì˜ì¡´ì„± ì„¤ì¹˜ (npm ciê°€ ë” ë¹ ë¥´ê³  ì •í™•í•©ë‹ˆë‹¤)
RUN npm ci --legacy-peer-deps

# 3. ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# 4. ë¹Œë“œ ì‹¤í–‰ (ê²½ë¡œ ìˆ˜ì • ë° ì‹¤í–‰ íŒŒì¼ ëª…ì‹œ)
# npx ëŒ€ì‹  ì‹¤ì œ ì„¤ì¹˜ëœ ê²½ë¡œë¥¼ ì§ì ‘ ì§€ì •í•˜ì—¬ ì—ëŸ¬ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
RUN cd aichat && \
    echo "ğŸš€ Starting nest build for aichat..." && \
    NODE_OPTIONS="--max-old-space-size=2048" ../node_modules/.bin/nest build

# --- 2ë‹¨ê³„: ì‹¤í–‰ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine
WORKDIR /app

RUN apk add --no-cache libc6-compat

# 5. ê²°ê³¼ë¬¼ ë³µì‚¬ (aichat ê²½ë¡œ í™•ì¸)
COPY --from=builder /app/aichat/dist ./dist
COPY --from=builder /app/aichat/node_modules ./node_modules
COPY --from=builder /app/aichat/package.json ./package.json

EXPOSE 3000
CMD ["node", "dist/main"]
