# 1ë‹¨ê³„: ë¹Œë“œ ìŠ¤í…Œì´ì§€
FROM node:20-alpine AS builder

# Alpineì—ì„œ ë¹Œë“œ ì‹œ í•„ìš”í•œ í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬
RUN apk add --no-cache libc6-compat
WORKDIR /app

# 1. íŒ¨í‚¤ì§€ íŒŒì¼ ë³µì‚¬
COPY package*.json ./
COPY aichat/package*.json ./aichat/

# 2. ì˜ì¡´ì„± ì„¤ì¹˜ (ë£¨íŠ¸ì—ì„œ ì§„í–‰)
RUN npm ci --legacy-peer-deps

# 3. ì†ŒìŠ¤ ì „ì²´ ë³µì‚¬
COPY . .

# 4. ğŸ”¹ [í•µì‹¬ ìˆ˜ì •] npx ëŒ€ì‹  ì§ì ‘ ì‹¤í–‰ íŒŒì¼ ê²½ë¡œ ì§€ì •
# npx nest build aichat ëŒ€ì‹  ë°”ì´ë„ˆë¦¬ ìœ„ì¹˜ë¥¼ ì§ì ‘ ì°”ëŸ¬ì¤ë‹ˆë‹¤.
RUN ./node_modules/.bin/nest build aichat

# 2ë‹¨ê³„: ì‹¤í–‰ ìŠ¤í…Œì´ì§€
FROM node:20-alpine
WORKDIR /app
RUN apk add --no-cache libc6-compat

# 5. ë¹Œë“œ ê²°ê³¼ë¬¼ë§Œ ë³µì‚¬
COPY --from=builder /app/aichat/dist ./dist
COPY --from=builder /app/aichat/node_modules ./node_modules
COPY --from=builder /app/aichat/package.json ./package.json

EXPOSE 3000
CMD ["node", "dist/main"]
