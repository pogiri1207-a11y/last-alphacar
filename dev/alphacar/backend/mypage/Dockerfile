# ---------------------------------------------------
# 1. ë¹Œë“œ ë‹¨ê³„ (Builder)
# ---------------------------------------------------
FROM node:20-alpine AS builder

# ì‘ì—… ë””ë ‰í„°ë¦¬ë¥¼ ë£¨íŠ¸(/app)ë¡œ ì„¤ì •
WORKDIR /app

# í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apk add --no-cache libc6-compat

# [ìµœì í™” 1] íŒ¨í‚¤ì§€ íŒŒì¼ ë¨¼ì € ë³µì‚¬ (ìºì‹œ íš¨ìœ¨ ê·¹ëŒ€í™”)
COPY package.json package-lock.json ./
COPY mypage/package*.json ./mypage/

# [ìµœì í™” 2] ê¸€ë¡œë²Œ Nest CLI ì„¤ì¹˜ ì œê±° (ì•½ 2ë¶„ ë‹¨ì¶•)
# npm install ëŒ€ì‹  npm cië¥¼ ì‚¬ìš©í•˜ë©´ ë¹Œë“œ ì†ë„ê°€ í›¨ì”¬ ë¹ ë¦…ë‹ˆë‹¤.
RUN npm ci --legacy-peer-deps

# [ìµœì í™” 3] ì†ŒìŠ¤ ì½”ë“œ ë° í•„ìš”í•œ ìŠ¤í‚¤ë§ˆë§Œ ë³µì‚¬
COPY . .

# [ìµœì í™” 4] ë¹Œë“œ ì‹¤í–‰ (npx ì‚¬ìš© ë° ë©”ëª¨ë¦¬ ì œí•œ)
# 5GB ë©”ëª¨ë¦¬ë¥¼ ê³ ë ¤í•˜ì—¬ 2048MBë¡œ ì œí•œí•©ë‹ˆë‹¤.
RUN cd mypage && \
    echo "ğŸš€ Starting nest build for mypage..." && \
    NODE_OPTIONS="--max-old-space-size=2048" npx nest build

# ---------------------------------------------------
# 2. ì‹¤í–‰ ë‹¨ê³„ (Runner)
# ---------------------------------------------------
FROM node:20-alpine AS runner

WORKDIR /app
ENV NODE_ENV=production
ENV PORT=3006

# 2-1. ì˜ì¡´ì„± ë° ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
# ë¹Œë“œ ìŠ¤í…Œì´ì§€ì—ì„œ ìƒì„±ëœ í•„ìš”í•œ íŒŒì¼ë§Œ ê°€ì ¸ì™€ ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ìµœì†Œí™”í•©ë‹ˆë‹¤.
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/mypage/node_modules ./mypage/node_modules
COPY --from=builder /app/mypage/dist ./dist
COPY --from=builder /app/mypage/package.json ./package.json

EXPOSE 3006

# ì‹¤í–‰ ê²½ë¡œë¥¼ dist ë‚´ë¶€ì˜ mainìœ¼ë¡œ ì„¤ì •
CMD ["node", "dist/main"]
