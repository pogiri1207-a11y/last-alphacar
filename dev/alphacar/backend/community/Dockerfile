# --- 1ë‹¨ê³„: ë¹Œë“œ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine AS builder

# ë¹Œë“œì— í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
RUN apk add --no-cache libc6-compat
WORKDIR /app

# 1. ì˜ì¡´ì„± ì„¤ì¹˜ ìµœì í™” (ìºì‹œ í™œìš©)
# ì  í‚¨ìŠ¤ ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸(backend/) ê¸°ì¤€ ê²½ë¡œì…ë‹ˆë‹¤.
COPY news/package*.json ./
# ê¸€ë¡œë²Œ ì„¤ì¹˜(-g)ë¥¼ ì œê±°í•˜ê³  npxë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œê°„ì„ ë‹¨ì¶•í•©ë‹ˆë‹¤.
RUN npm ci --legacy-peer-deps

# 2. ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY news/ .

# 3. ë¹Œë“œ ì‹¤í–‰
# ë©”ëª¨ë¦¬ ì œí•œì„ 2GBë¡œ ë‚®ì¶° ì„œë²„ ë‹¤ìš´ì„ ë°©ì§€í•©ë‹ˆë‹¤.
RUN echo "ğŸš€ Starting nest build for news..." && \
    NODE_OPTIONS="--max-old-space-size=2048" npx nest build

# --- 2ë‹¨ê³„: ì‹¤í–‰ ìŠ¤í…Œì´ì§€ ---
FROM node:20-alpine
WORKDIR /app

RUN apk add --no-cache libc6-compat

# 4. ê²°ê³¼ë¬¼ë§Œ ë³µì‚¬ (ê²½ë¡œ ë‹¨ìˆœí™”)
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json

EXPOSE 3000

# 5. ì‹¤í–‰
CMD ["node", "dist/main"]
