# --- 1ë‹¨ê³„: ë¹Œë“œ ìŠ¤í…Œì´ì§€ (Builder) ---
FROM node:20-alpine AS builder

# ë¹Œë“œ ì‹œ í•„ìš”í•œ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
RUN apk add --no-cache libc6-compat
WORKDIR /app

# [ìµœì í™” 1] íŒ¨í‚¤ì§€ íŒŒì¼ë§Œ ë¨¼ì € ë³µì‚¬í•˜ì—¬ ìºì‹œ í™œìš© (ë§¤ìš° ì¤‘ìš”)
# ì†ŒìŠ¤ ì½”ë“œê°€ ë°”ë€Œì–´ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ê·¸ëŒ€ë¡œë©´ ì´ ë‹¨ê³„ëŠ” 1ì´ˆ ë§Œì— ë„˜ì–´ê°‘ë‹ˆë‹¤.
COPY package*.json ./
COPY news/package*.json ./news/

# [ìµœì í™” 2] @nestjs/cli ì „ì—­ ì„¤ì¹˜ ì œê±° ë° npm ci ì‚¬ìš©
# npm installë³´ë‹¤ ë¹Œë“œ í™˜ê²½ì— ìµœì í™”ëœ npm cië¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.
RUN npm ci --legacy-peer-deps

# [ìµœì í™” 3] ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ (ì˜ì¡´ì„± ì„¤ì¹˜ ì´í›„ì— ìˆ˜í–‰)
COPY . .

# [ìµœì í™” 4] ë¹Œë“œ ì‹¤í–‰ (ë©”ëª¨ë¦¬ ì œí•œ í•˜í–¥ ë° npx ì‚¬ìš©)
# ê°€ìš© ë©”ëª¨ë¦¬ 5GBë¥¼ ê³ ë ¤í•˜ì—¬ 2048MBë¡œ ì œí•œí•´ì•¼ ë³‘ë ¬ ë¹Œë“œ ì‹œ ì„œë²„ê°€ ì£½ì§€ ì•ŠìŠµë‹ˆë‹¤.
RUN cd news && \
    echo "ğŸš€ Starting nest build for news..." && \
    NODE_OPTIONS="--max-old-space-size=2048" npx nest build

# --- 2ë‹¨ê³„: ì‹¤í–‰ ìŠ¤í…Œì´ì§€ (Runner) ---
FROM node:20-alpine
WORKDIR /app

RUN apk add --no-cache libc6-compat

# [ìµœì í™” 5] ì‹¤í–‰ì— í•„ìš”í•œ ìµœì†Œ íŒŒì¼ë§Œ ë³µì‚¬
# ì´ë¯¸ì§€ ìš©ëŸ‰ì„ ì¤„ì—¬ Harbor ì „ì†¡ ì†ë„ë¥¼ ë†’ì…ë‹ˆë‹¤.
COPY --from=builder /app/news/dist ./dist
COPY --from=builder /app/news/node_modules ./node_modules
COPY --from=builder /app/news/package.json ./package.json

EXPOSE 3000

# NestJS ê¸°ë³¸ ë¹Œë“œ ê²°ê³¼ë¬¼ì€ dist/main.jsì…ë‹ˆë‹¤.
CMD ["node", "dist/main"]
